language: java

jdk:
  - oraclejdk8

dist: trusty

cache:
  directories:
    - "$HOME/google-cloud-sdk/"
    - "$HOME/.m2/"

env:
  global:
    - PATH=$PATH:${HOME}/google-cloud-sdk/bin
    # CI_DEPLOY_USERNAME
    - secure: aatnyQCO8F79sc2IvA6efAew2oilalgBgh5Q8nhpdorf+UlfLeFBlqiImU6EmFBbwgBgwZRQLARKQkpe3wcqLVoacf2YDKPmbBgFtph2Mmdy4uyNRD6EShyW9FiHThWN6iy5CYd9XI8sWiDW7GmD1pP9+SKdBA4G7JHzFcYap6ZiOnTz2BZ7oJndKRgLMFBLU+bGFsIAHchk4KoQFk0W1OGkDY/otasMmUQ56tHKsGJaAzcCF6Xr5qdprTgUIK+fUmL3QgNKseUxTE6QGQGQOGLCrGVQ7cMOsweTJUo/k88eliqEkee6BrH847NP+KrJ79gy4hOf8xDdCrjOquruz91EOPXIEGodKJlznHBUXdpT1VwltJ9Iv6c6DbOcZkMKv2xHc+yHo/D5NRxg0Zy1drTYu25hTOJCw/mvY5gPZiqLivoMIJLAD33LUU5c6F09ROE7SNAUYRIzrsNVcg9Mcyv1uz34sOlj58+GaN3Rzj3/D9d2CcJe0l29pxesYk4IbJ6ofM6Pp5FwYVtk2TuSmkeXoYU0YWLUZN1KxM5JCMjOTCUVRxEfrYPOb338O/PBQ7j7anpPAoXMG98Gr7EOGwqEDRyr91nBvRjRSAVcVtWRFJ5khZWqbUBkv/isI9Af4e8rPUgsb7SzW/QmRWPwYCcBP/un3B+v8dbim4aDtJU=
    # CI_DEPLOY_PASSWORD
    - secure: GkVJrZ1PQn8wT+wL7zSjjvDWKvooPyP+ESkkGaqAxlfl+miFaB7YPWPL3K9JpvodZ3uh+7W2hd1WuqSlTQo7sKReaH3hdfYWO43JgcLkVf7dNiVysEOuNFesRawvchKHYy5+QdHfwX3gqBmFJWqVXsBL3v4NVQZaEmhSAxMoSjwJsAamArPG/3DHlt0daTXC9yeraG3cF5GiBeuYrbSzvYMF1z0Z5te9E7F68f7xZCjGFq2cgYQbLyxzErZFXJZcxrMoz6i/HNcChEVQmqqLqNt4rykyDVnjy4IhWw45eujBnBvs0qwBVGIjaarl0ZmQh8dV+DbOQIA3wxXFQVhJdMeu2tai+MHRWYHM+Q3vfrO5Tv3CpWLaKroJeRRNyHLeTtmAUT4JE5D/kpUS71BuWF1ibWVWBKGNNoKZzz2DwqAf4tj1D1DQL+qt7PqXHgqOL3pTT3FuXIpR07TqMlmlnsH3DCyEwTD4f43KMlrj93G+AowVYTP/jlCXAxoO4I4IOJeqpWiEg7LGqdzBYkI6j3po7vASvJzNVUWIn9glf+lljLrV7qH8AMaD4S4n+2XvxMrBodDx8QhcvMCDIDPZOQ13xrhGCR8veu4D3qeA3dtL4RQ/0PAg7J/Ar9RgUdRDXggNDMmN+uCHJY4t5dmhp7CENTsA2Y0jNawgM30gccM=
    # GPG_KEY_NAME
    - secure: KaWXLFGOKxb/um0nOE6gPOVKtWzlzTgZdRevYpiRr+4aCwe0UzjD68EpJxmVy3RS+HrhqPlly8g2QiDlojj+EFun1bK6Itnw0pivwwnzz75bJ+0+S/fPiShawW4bsirOYPZLPHH7l5OFPIulzkXnQNYNjK1QBQvJwBO7aJcy7aifcRlWOmuNiMuj9fQV8eSqkePyoewD4MfjcyiqL+i14hDSMgk6NtsLEza6W/nl6h07EKQ9Sx1s+SWs3mVxPXPsfoxsgmU2kF7UjFP+Bd/uG6jLVu7H5Bv3wElSNODf6zyhYZk8uf45acNQQhsiLhuABFJdiwLuNW5sdJxcTtjUf9yg0wTvrkktoR79IhuOtHkdO306yI6xDRP3EGEhdHUvJd95rCDIPNJI9Wp5twr1B7PhdHrPPbE4zgfR1u+3pWYIVEb3/5N8pinkrSaQh0ckzPdxBg9Jj/qRk/QiFy6Sb7dSM0Gu9zqMYPGsPL5l7Shz0279lLDupMMJsXwEf9+LZ5J6GQMKA9HHExpEVK65sDtqV6/PkQqo/Epb7kli6wzCpvtgxkpkYPQH1OpKXyETeEjeOvSoyyoLqSIym+GErYRRnLRpmS9CKhyQt5MUJUWrWHm+92fMopWMWgzSEw3mSCpjawrvcMZTQ82Rjz8U73Ckg9gDVLj/dYNVg8jrg1M=
    # GPG_PASSPHRASE
    - secure: k9I6YcBeKurh4HdIlqC0vgO36njsH2KieI+jaU/tXxKpfk8EkmyC5AsNanf7oNBrgfxICNNOYdoozq94+qBvmHUQtTSna6wuhGOq6O9kR/uaQfV6AxrK6rBESRpfi6zwh2nVwH2G9KAch7isEQ4TJ42Jw1I8qrf5URNj4JZkFwXchtc0xYvInymLuWcwto/ZmFRi4/9X3SFwnn5TteDlc5gQIte6jlbBSqJybSnhfM7ZzDLEIVDrp72h8Rz/EcOMP7/FrN23CgjR3gz8hgv4ISfgfwZJMnzRxYPTKAEsMAaaD1BGyurDRXysFYJ01xjJoWwnLXr6BcAPPTtiGWblh+jGQCR4B7xX7rk1vB5y9nb+CEpfj1Xh9H2X8bm2U7Jx9lvtzGqSEeWUvRG7Rm1YDkNd60S3TkO7mRRH7oYagxZE11p9S+FCMOX6HzLDtKEAc4DrAebyHlQkBF22G2Mcgpk1BwZrq45Jwg/QEGKWIRm74zGfACitjD+/3e2+tk4S7VSnTPaZGd1TdUgJPpn9M8R0kS5sA7wfXaZ79obfilhT5zmh9kFIHFJL7wuz1+nieHkuVwvm2WQUj/fZtII0H3AYDi1v5TG2Ms6nP/veAqyh09OG8LpFaFekV/ZKY9a9Y0Ws3iSW8kbnRiAUrfNYQ6sjkk/S2w+m1PuVN/1d22I=

before_install:
  # Decrypt the secrets (only non pull-requests)
  - export CREDENTIALS_STORE=$(mktemp -d)
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then openssl aes-256-cbc -K $encrypted_3b9f0b9d36d1_key -iv $encrypted_3b9f0b9d36d1_iv -in travis_files/secrets.tar.enc -out travis_files/secrets.tar -d; fi
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then tar xvf travis_files/secrets.tar --directory $CREDENTIALS_STORE; fi
  # Import the FOSS signing key
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then gpg --fast-import ${CREDENTIALS_STORE}/spydra_sign_keys; fi
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then export GOOGLE_APPLICATION_CREDENTIALS=${CREDENTIALS_STORE}/spydra_foss_ci.json; fi
  # If the SDK is not already cached, download it and install it into path
  - gcloud version || true
  - if [ ! -d "$HOME/google-cloud-sdk/bin" ]; then rm -rf $HOME/google-cloud-sdk; export CLOUDSDK_CORE_DISABLE_PROMPTS=1; curl https://sdk.cloud.google.com | bash; fi
  - source $HOME/google-cloud-sdk/path.bash.inc
  - gcloud components install --quiet beta || true
  - gcloud version
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then gcloud auth activate-service-account --key-file $GOOGLE_APPLICATION_CREDENTIALS; fi

branches:
  only:
  - master

# Skipping the install step as the script step will do all we need.
install: true

script:
  # Run on pull requests (encrypted data not available for pull requests)
  - 'if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then mvn clean verify; fi'
  # Run on merges to master
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then mvn deploy -P release,install-init-scripts --settings=travis_files/settings.xml; fi'

notifications:
  email: false
